{
   "metadata":{
      "variables":{
         "ROOT_PATH":"~/.deeppavlov",
         "BACKBONE":"distilbert-base-uncased",
         "MODELS_PATH":"{ROOT_PATH}/models_multitask",
         "SAVE_LOAD_PATH":"{MODELS_PATH}/{BACKBONE}",
         "NER_DATA_PATH":"~/GLUE/CONLL2003",
         "NUM_TRAIN_EPOCHS":5,
         "GRADIENT_ACC_STEPS":1
      }
   },
   "dataset_reader":{
      "class_name":"multitask_reader",
      "train":"train",
      "valid":"validation",
      "test":"test",
      "path":"default unused value",
      "data_path":"default unused value",
      "tasks":{
         "cola":{
            "reader_class_name":"huggingface_dataset_reader",
            "path":"glue",
            "name":"cola"
         },   
         "rte":{
            "reader_class_name":"huggingface_dataset_reader",
            "path":"glue",
            "name":"rte"
         },    
         "stsb":{
            "reader_class_name":"huggingface_dataset_reader",
            "path":"glue",
            "name":"stsb"
         },       
         "copa":{
            "reader_class_name":"huggingface_dataset_reader",
            "path":"super_glue",
            "name":"copa"
         },
      "conll": {
        "reader_class_name": "conll2003_reader",
        "data_path": "{NER_DATA_PATH}/conll2003/",
        "dataset_name": "conll2003",
        "provide_pos": false
      }
      }
   },
   "dataset_iterator":{
      "class_name":"multitask_iterator",
      "num_train_epochs":"{NUM_TRAIN_EPOCHS}",
      "gradient_accumulation_steps":"{GRADIENT_ACC_STEPS}",
      "iterator_class_name":"huggingface_dataset_iterator",
      "label":"label",
      "use_label_name":false,
      "seed":42,
      "tasks":{
         "cola":{
            "features":[
               "sentence"
            ]
         },
         "rte":{
            "features":[
               "sentence1",
               "sentence2"
            ]
         },
         "stsb":{
            "features":[
               "sentence1",
               "sentence2"
            ]
         },
         "copa":{
            "features":[
               "contexts",
               "choices"
            ]
         },
         "conll":{
            "iterator_class_name":"basic_classification_iterator"

         }
      }
   },
   "chainer":{
      "in":[
         "x_cola",
         "x_rte",
         "x_stsb",
         "x_copa",
         "x_conll"
      ],
      "in_y":[
         "y_cola",
         "y_rte",
         "y_stsb",
         "y_copa",
         "y_conll"
      ],
      "pipe":[
         {
            "class_name":"multitask_pipeline_preprocessor",
            "possible_keys_to_extract":[
               0,
               1
            ],
            "preprocessors":[
               "TorchTransformersPreprocessor",
               "TorchTransformersPreprocessor",
               "TorchTransformersPreprocessor",
               "TorchTransformersMultiplechoicePreprocessor",
               "TorchTransformersNerPreprocessor"
            ],
            "do_lower_case":true,
            "n_task":5,
            "vocab_file":"{BACKBONE}",
            "max_seq_length":200,
            "max_subword_length":15,
            "token_masking_prob":0.0,
            "return_features":true,
            "in":[
               "x_cola",
               "x_rte",
               "x_stsb",
               "x_copa",
               "x_conll"
            ],
            "out":[
               "bert_features_cola",
               "bert_features_rte",
               "bert_features_stsb",
               "bert_features_copa",
               "bert_features_conll"
            ]
         },
         {
            "id":"vocab_conll",
            "class_name":"simple_vocab",
            "unk_token":[
               "O"
            ],
            "pad_with_zeros":true,
            "save_path":"{MODELS_PATH}/tag.dict",
            "load_path":"{MODELS_PATH}/tag.dict",
            "fit_on":[
               "y_conll"
            ],
            "in":[
               "y_conll"
            ],
            "out":[
               "y_ids_conll"
            ]
         },
         {
            "id":"multitask_bert",
            "class_name":"multitask_bert",
            "optimizer_parameters":{
               "lr":2e-5
            },
            "gradient_accumulation_steps":"{GRADIENT_ACC_STEPS}",
            "learning_rate_drop_patience":2,
            "learning_rate_drop_div":2.0,
            "return_probas":true,
            "backbone_model":"{BACKBONE}",
            "save_path":"{SAVE_LOAD_PATH}",
            "load_path":"{SAVE_LOAD_PATH}",
            "tasks":{
               "cola":{
                  "type":"classification",
                  "options":2
               },
               "rte":{
                  "type":"classification",
                  "options":2
               },
               "stsb":{
                  "type":"regression",
                  "options":1
               },
               "copa":{
                  "type":"multiple_choice",
                  "options":2
               },
               "conll":{
                  "type":"sequence_labeling",
                  "options":"#vocab_conll.len"
               }
            },
            "in":[
               "bert_features_cola",
               "bert_features_rte",
               "bert_features_stsb",
               "bert_features_copa",
               "bert_features_conll"
            ],
            "in_y":[
               "y_cola",
               "y_rte",
               "y_stsb",
               "y_copa",
               "y_ids_conll"
            ],
            "out":[
               "y_cola_pred_probas",
               "y_rte_pred_probas",
               "y_stsb_pred",
               "y_copa_pred_probas",
               "y_conll_pred_ids"
            ]
         },
         {
            "in":[
               "y_cola_pred_probas"
            ],
            "out":[
               "y_cola_pred_ids"
            ],
            "class_name":"proba2labels",
            "max_proba":true
         },
         {
            "in":[
               "y_rte_pred_probas"
            ],
            "out":[
               "y_rte_pred_ids"
            ],
            "class_name":"proba2labels",
            "max_proba":true
         },
         {
            "in":[
               "y_copa_pred_probas"
            ],
            "out":[
               "y_copa_pred_ids"
            ],
            "class_name":"proba2labels",
            "max_proba":true
         },
         {
            "in":[
               "y_conll_pred_ids"
            ],
            "out":[
               "y_conll_pred_labels"
            ],
            "ref":"vocab_conll"
         }
      ],
      "out":[
         "y_cola_pred_ids",
         "y_rte_pred_ids",
         "y_stsb_pred",
         "y_copa_pred_ids",
         "y_conll_pred_labels"
      ]
   },
   "train":{
      "epochs":"{NUM_TRAIN_EPOCHS}",
      "batch_size":32,
      "metrics":[
         {
            "name":"multitask_accuracy",
            "inputs":[
               "y_rte",
               "y_cola",
               "y_copa",
               "y_rte_pred_ids",
               "y_cola_pred_ids",
               "y_copa_pred_ids"
            ]
         },
         {
            "name":"ner_f1",
            "inputs":[
               "y_conll",
               "y_conll_pred_labels"
            ]
         },
         {
            "name":"ner_token_f1",
            "inputs":[
               "y_conll",
               "y_conll_pred_labels"
            ]
         },
         {
            "name":"accuracy",
            "alias":"accuracy_cola",
            "inputs":[
               "y_cola",
               "y_cola_pred_ids"
            ]
         },
         {
            "name":"accuracy",
            "alias":"accuracy_rte",
            "inputs":[
               "y_rte",
               "y_rte_pred_ids"
            ]
         },
         {
            "name":"accuracy",
            "alias":"accuracy_copa",
            "inputs":[
               "y_copa",
               "y_copa_pred_ids"
            ]
         },
         {
            "name":"pearson_correlation",
            "alias":"pearson_stsb",
            "inputs":[
               "y_stsb",
               "y_stsb_pred"
            ]
         },
         {
            "name":"spearman_correlation",
            "alias":"spearman_stsb",
            "inputs":[
               "y_stsb",
               "y_stsb_pred"
            ]
         }
      ],
      "validation_patience":3,
      "val_every_n_epochs":1,
      "log_every_n_epochs":1,
      "show_examples":false,
      "evaluation_targets":[
         "valid"
      ],
      "class_name":"torch_trainer"
   }
}
